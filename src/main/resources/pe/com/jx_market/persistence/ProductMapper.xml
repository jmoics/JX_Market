<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="pe.com.jx_market.persistence.ProductMapper">

    <cache />

    <!-- MANTENIMIENTO DE PRODUCTOS -->

    <select id="getArticulos" parameterType="java.util.Map" resultMap="productResultMap">
        SELECT
            art.id as productId,
            art.empresaid as productEmpresaId,
            art.nombre as productName,
            art.descripcion as productDescription,
            art.activo as productActivo,
            cart.id as catProdId,
            cart.categoryid as categoryId,
            cat.id as categoryId,
            cat.empresaid as categoryEmpresaId,
            cat.nombre as categoryName,
            cat.estado as categoryEstado,
            cat.parentid as categoryParentId,
            mar.id as marcaId,
            mar.empresaid as marcaEmpresaId,
            mar.nombre as marcaName,
            mar.activo as marcaActivo,
            img.id as imageId,
            img.empresaid as imageEmpresaId,
            img.productid as productImageId,
            img.nombre as imageName,
            img.imagdefault as imageDefault,
            img.active as imageActive
        FROM
            T_NEG_ARTICULO art LEFT JOIN
            T_NEG_CATEG2ARTIC cart ON art.id = cart.productid LEFT JOIN
            T_NEG_CATEGORIA cat ON cart.categoryid = cat.id LEFT JOIN
            T_NEG_MARCA mar ON art.marcaid = mar.id LEFT JOIN
            T_NEG_IMAGE4PRODUCT img ON art.id = img.productid
        <where>
            <if test="empresa != null">
                art.empresaid = #{empresa}
                <if test="lstCategory != null">AND
                    cart.categoryid in
                    <foreach item="id" index="index" collection="lstCategory"
                             open="(" separator="," close=")">
                            #{id, jdbcType=INTEGER}
                    </foreach>
                </if>
                <if test="nombre != null">AND
                    art.nombre LIKE %#{nombre}%
                </if>
                <if test="activo != null">AND
                    art.activo = #{activo}
                </if>
            </if>
        </where>
    </select>

    <select id="getArticuloXCodigo" parameterType="DTO_Product" resultType="DTO_Product">
        SELECT
            art.id as id,
            art.empresaid as empresa,
            art.nombre as productName,
            --art.marcaId as marca,
            art.descripcion as productDescription,
            art.activo as activo
        FROM
            T_NEG_ARTICULO art
        WHERE
            art.id = #{id, jdbcType=INTEGER}
    </select>

    <insert id="insertArticulo" parameterType="DTO_Product" useGeneratedKeys="true" keyProperty="id" keyColumn="ID">
        INSERT INTO T_NEG_ARTICULO
            (empresaid,nombre,
            descripcion,marcaid,
            activo)
        VALUES
            (#{empresa},#{productName},
            #{productDescription},#{marca.id},
            #{activo})
    </insert>

    <update id="updateStock" parameterType="DTO_Product">
        UPDATE T_NEG_ARTICULO
        SET
            articulo_n_stock = #{stock}
        WHERE
            empresa_n_codigo = #{empresa}
        AND
            articulo_n_codigo = #{codigo}
    </update>

    <update id="updateArticulo" parameterType="DTO_Product">
        UPDATE T_NEG_ARTICULO
        SET
            nombre = #{productName},
            descripcion = #{productDescription},
            activo = #{activo}
        WHERE
            id = #{id}
        AND
            empresaid = #{empresa}
    </update>

    <delete id="deleteArticulo">
        DELETE FROM
        T_NEG_ARTICULO
        WHERE
        id = #{value}
    </delete>

    <select id="getCategories4Product" parameterType="DTO_Category2Product" resultType="int">
        SELECT
            count(*)
        FROM
            T_NEG_CATEG2ARTIC cat4art
        WHERE
            cat4art.productid = #{productId} AND
            cat4art.categoryid = #{categoryId}
    </select>

    <insert id="insertCategory4Product" parameterType="DTO_Category2Product">
        INSERT INTO T_NEG_CATEG2ARTIC
            (productid,categoryid)
        VALUES
            (#{productId},#{categoryId})
    </insert>

    <delete id="deleteCategory4Product" parameterType="DTO_Category2Product">
        DELETE FROM
            T_NEG_CATEG2ARTIC
        WHERE
            productid = #{productId} AND
            categoryid = #{categoryId}
    </delete>

    <insert id="insertImage4Product" parameterType="DTO_ProductImage" useGeneratedKeys="true" keyProperty="id" keyColumn="ID">
        INSERT INTO T_NEG_IMAGE4PRODUCT
            (empresaid,productid,nombre,imagdefault,active)
        VALUES
            (#{company},#{productId},#{imageName},#{imageDefault},#{imageActive})
    </insert>

    <update id="updateImage4Product" parameterType="DTO_ProductImage">
        UPDATE T_NEG_IMAGE4PRODUCT
        SET
            imagdefault = #{imageDefault},
            active = #{imageActive}
        WHERE
            id = #{id}
        AND
            empresaid = #{company}
    </update>

    <delete id="deleteImage4Product" parameterType="DTO_ProductImage">
        DELETE FROM
            T_NEG_IMAGE4PRODUCT
        WHERE
            id = #{id}
    </delete>

    <resultMap id="productResultMap" type="DTO_Product">
        <id property="id" column="productId" />
        <result property="empresa" column="productEmpresaId" />
        <result property="productName" column="productName" />
        <result property="productDescription" column="productDescription" />
        <result property="activo" column="productActivo" />
        <!-- <collection property="categorias2Articulos" column="catProdId"
                    ofType="DTO_Category2Product" javaType="ArrayList" resultMap="category2ProductMap">
        </collection> -->
        <association property="marca" column="marcaId" javaType="DTO_TradeMark" resultMap="marcaResultMap">
        </association>
        <collection property="categories" column="catProdId"
                    ofType="DTO_Category" javaType="ArrayList" resultMap="categoryResultMap">
        </collection>
        <collection property="images" column="imageId"
                    ofType="DTO_ProductImage" javaType="ArrayList" resultMap="imageResultMap">
        </collection>
    </resultMap>

    <!-- <resultMap id="category2ProductMap" type="DTO_Category2Product">
        <id property="id" column="catProdId" />
        <result property="categoryId" column="categoryId" />
        <result property="productId" column="productId" />
    </resultMap>-->
    <resultMap id="categoryResultMap" type="DTO_Category">
        <id property="id" column="categoryId" />
        <result property="empresa" column="categoryEmpresaId" />
        <result property="categoryName" column="categoryName" />
        <result property="estado" column="categoryStatus" />
        <result property="categoryParentId" column="categoryParentId" />
    </resultMap>
    <resultMap id="marcaResultMap" type="DTO_TradeMark">
        <id property="id" column="marcaId" />
        <result property="empresa" column="marcaEmpresaId" />
        <result property="marcaName" column="marcaName" />
        <result property="active" column="marcaActivo" />
    </resultMap>
    <resultMap id="imageResultMap" type="DTO_ProductImage">
        <id property="id" column="imageId" />
        <result property="company" column="imageEmpresaId" />
        <result property="productId" column="productImageId" />
        <result property="imageName" column="imageName" />
        <result property="imageDefault" column="imageDefault" />
        <result property="imageActive" column="imageActive" />
    </resultMap>

    <select id="selectCategoriasForArticulos" resultType="DTO_Category">
        SELECT
            cat.id as categoryId,
            cat.empresaid as empresa,
            cat.nombre as categoryName,
            cat.estado as estado,
            cat.parentid as categoryParentId
        FROM
            T_NEG_CATEGORIA cat,
            T_NEG_CATEG2ARTIC cart
        WHERE
            cart.cate_n_id = cat.categoria_n_codigo
        AND cart.arti_n_id = #{articulo_n_codigo}
    </select>

    <!-- <select id="getObject" parameterType="Map" resultType="hashmap">
        select * from TABL where
        <foreach  collection="dataMap"  index="key" item="value"  open=""  separator=" and "  close="">
            #{key}=#{value}
        </foreach>
    </select>-->

</mapper>